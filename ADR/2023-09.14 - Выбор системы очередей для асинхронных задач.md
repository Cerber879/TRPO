**Дата:** 20 сентября 2023 г.

**Статус:** Принято

**Контекст:**

Система поиска и рекомендаций ресторанов требует выполнения асинхронных задач, которые не должны блокировать основной поток обработки запросов пользователей. К таким задачам относятся: обработка изображений, пересчет рейтингов, генерация рекомендаций, отправка уведомлений, индексация данных для поиска.

**Рассмотренные варианты:**

1. **RabbitMQ:** Популярный брокер сообщений с поддержкой различных паттернов обмена сообщениями. Надежный, но требует настройки.
2. **Apache Kafka:** Распределенная платформа потоковой обработки данных. Отлично для больших объемов данных и event streaming.
3. **Redis как очередь:** Использование Redis Lists или Streams для простых очередей задач. Легко, но менее функционально.
4. **Amazon SQS / Google Cloud Tasks:** Управляемые сервисы очередей. Простое использование, но зависимость от облачного провайдера.

**Решение:**

Выбран Redis Streams для простых задач и RabbitMQ для сложных сценариев с гарантиями доставки.

**Обоснование:**

- **Простота:** Redis уже используется в проекте для кэширования, что упрощает инфраструктуру.
- **Производительность:** Redis Streams обеспечивает высокую производительность для большинства асинхронных задач проекта.
- **Гибкость:** Redis Streams поддерживает consumer groups, что позволяет масштабировать обработку задач.
- **Резервный вариант:** RabbitMQ может быть добавлен для задач, требующих более сложной маршрутизации или гарантий доставки.
- **Стоимость:** Не требует дополнительной инфраструктуры на начальном этапе.

**Недостатки решения:**

- **Ограниченная функциональность:** По сравнению с RabbitMQ, Redis Streams имеет меньше возможностей для сложной маршрутизации сообщений.
- **Персистентность:** Необходимо правильно настроить персистентность Redis для предотвращения потери задач при сбоях.

**Последствия:**

- Необходимо реализовать абстракцию над системой очередей для возможности переключения между Redis и RabbitMQ.
- Требуется настройка consumer groups в Redis Streams для параллельной обработки задач.
- Необходимо реализовать механизм retry для обработки неудачных задач.
- Рекомендуется мониторинг длины очередей для предотвращения переполнения.
- Для критических задач (например, отправка уведомлений) следует рассмотреть использование RabbitMQ с гарантиями доставки.

