@startuml
!include <C4/C4_Container>

' Чтобы линии были "прямыми" и меньше хаоса
skinparam linetype ortho
LAYOUT_LEFT_RIGHT()
LAYOUT_WITH_LEGEND()

title Система поиска и рекомендаций ресторанов — Container (с отдельными БД по сервисам)

Person(посетитель, "Посетитель", "Ищет рестораны, просматривает карточки, оставляет отзывы")
Person(владелец, "Владелец ресторана", "Управляет карточкой ресторана, анализирует статистику")
Person(модератор, "Модератор", "Проверяет контент, обрабатывает жалобы")
Person(рекламодатель, "Рекламодатель", "Создает рекламные кампании")

System_Ext(yandex_maps, "Yandex Maps API", "Картографический сервис")
System_Ext(oauth_providers, "OAuth провайдеры", "Google, Facebook")

System_Boundary(sys, "Система поиска и рекомендаций ресторанов") {

    Container(web_app, "Веб-приложение", "React, TypeScript", "SPA для всех типов пользователей")
    Container(mobile_app, "Мобильное приложение", "React Native, TypeScript", "iOS/Android")
    Container(api_gateway, "API Gateway", "Kotlin, Spring Cloud Gateway", "Маршрутизация, auth, rate limiting")

    ' Общая инфраструктура (можно оставить внутри системы как часть решения)
    Container(message_broker, "RabbitMQ", "RabbitMQ", "Очереди/события для асинхронных задач")
    Container(redis_cache, "Redis", "Redis", "Кэш + хранение сессий/refresh")

    ' ==== Микросервисы: каждый в своём прямоугольнике с БД/схемой ====
    together {

        Container_Boundary(auth_b, "Auth Service") {
            Container(auth_service, "Auth API", "Kotlin, Spring Boot", "JWT/OAuth/Session, RBAC")
            ContainerDb(auth_db, "Auth DB schema", "PostgreSQL schema", "Пользователи, роли, refresh tokens")
        }

        Container_Boundary(rest_b, "Restaurant Service") {
            Container(restaurant_service, "Restaurant API", "Kotlin, Spring Boot", "Карточки ресторанов")
            ContainerDb(rest_db, "Restaurant DB schema", "PostgreSQL schema", "Рестораны, адреса, атрибуты")
        }

        Container_Boundary(search_b, "Search Service") {
            Container(search_service, "Search API", "Kotlin, Spring Boot", "Поиск (PostgreSQL FTS + фильтры)")
            ContainerDb(search_db, "Search DB schema", "PostgreSQL schema", "FTS индексы/слои поиска (логически изолировано)")
        }

        Container_Boundary(reco_b, "Recommendations Service") {
            Container(recommendations_service, "Reco API", "Kotlin, Spring Boot", "Персональные рекомендации")
            ContainerDb(reco_db, "Reco DB schema", "PostgreSQL schema", "Профили/история/фичи")
        }

        Container_Boundary(reviews_b, "Reviews Service") {
            Container(reviews_service, "Reviews API", "Kotlin, Spring Boot", "Отзывы и рейтинги")
            ContainerDb(reviews_db, "Reviews DB schema", "PostgreSQL schema", "Отзывы, оценки, агрегаты")
        }

        Container_Boundary(mod_b, "Moderation Service") {
            Container(moderation_service, "Moderation API", "Kotlin, Spring Boot", "Очередь модерации, решения approve/reject")
            ContainerDb(mod_db, "Moderation DB schema", "PostgreSQL schema", "Очередь, решения, причины")
        }

        Container_Boundary(ads_b, "Advertising Service") {
            Container(advertising_service, "Ads API", "Kotlin, Spring Boot", "Рекламные кампании")
            ContainerDb(ads_db, "Ads DB schema", "PostgreSQL schema", "Кампании, таргетинг, бюджеты")
        }

        Container_Boundary(analytics_b, "Analytics Service") {
            Container(analytics_service, "Analytics API", "Kotlin, Spring Boot", "Аналитика владельцам")
            ContainerDb(analytics_db, "Analytics DB schema", "PostgreSQL schema", "События/агрегации/витрины")
        }

        Container_Boundary(image_b, "Image Service") {
            Container(image_service, "Image API", "Kotlin, Spring Boot", "Загрузка/обработка изображений")
            ContainerDb(image_db, "Image DB schema", "PostgreSQL schema", "Метаданные изображений")
            Container(image_storage, "Image Storage", "File System", "Файлы изображений и thumbnails")
        }
    }
}


' ===== Пользователи -> клиенты -> gateway =====
Rel(посетитель, web_app, "Использует", "HTTPS")
Rel(посетитель, mobile_app, "Использует", "HTTPS")
Rel(владелец, web_app, "Использует", "HTTPS")
Rel(модератор, web_app, "Использует", "HTTPS")
Rel(рекламодатель, web_app, "Использует", "HTTPS")

Rel(web_app, api_gateway, "API", "HTTPS")
Rel(mobile_app, api_gateway, "API", "HTTPS")

' ===== Gateway -> сервисы =====
Rel(api_gateway, auth_service, "Auth/RBAC", "HTTP")
Rel(api_gateway, restaurant_service, "Карточки ресторанов", "HTTP")
Rel(api_gateway, search_service, "Поиск", "HTTP")
Rel(api_gateway, recommendations_service, "Рекомендации", "HTTP")
Rel(api_gateway, reviews_service, "Отзывы/оценки", "HTTP")
Rel(api_gateway, moderation_service, "Модерация", "HTTP")
Rel(api_gateway, advertising_service, "Реклама", "HTTP")
Rel(api_gateway, analytics_service, "Аналитика", "HTTP")
Rel(api_gateway, image_service, "Изображения", "HTTP")

' ===== Сервис -> его БД (внутри прямоугольника, стрелки короткие и аккуратные) =====
Rel(auth_service, auth_db, "read/write", "JDBC")
Rel(restaurant_service, rest_db, "read/write", "JDBC")
Rel(search_service, search_db, "read/write (FTS)", "JDBC")
Rel(recommendations_service, reco_db, "read/write", "JDBC")
Rel(reviews_service, reviews_db, "read/write", "JDBC")
Rel(moderation_service, mod_db, "read/write", "JDBC")
Rel(advertising_service, ads_db, "read/write", "JDBC")
Rel(analytics_service, analytics_db, "read/write", "JDBC")
Rel(image_service, image_db, "read/write", "JDBC")
Rel(image_service, image_storage, "store/read files", "File IO")

' ===== Внешние зависимости =====
Rel(auth_service, oauth_providers, "OAuth 2.0", "HTTPS")
Rel(search_service, yandex_maps, "Геокодирование/поиск поблизости", "HTTPS")

' ===== Redis / RabbitMQ (оставил только ключевые связи, чтобы не было паутины) =====
Rel(auth_service, redis_cache, "sessions/refresh", "TCP")
Rel(search_service, redis_cache, "cache search results", "TCP")
Rel(restaurant_service, redis_cache, "cache cards/lists", "TCP")
Rel(recommendations_service, redis_cache, "cache recs", "TCP")
Rel(reviews_service, redis_cache, "cache ratings", "TCP")
Rel(advertising_service, redis_cache, "cache active ads", "TCP")

Rel(restaurant_service, message_broker, "Publish: RestaurantChanged", "AMQP")
Rel(reviews_service, message_broker, "Publish: ReviewCreated", "AMQP")
Rel(moderation_service, message_broker, "Consume/Publish: ReviewModerated", "AMQP")
Rel(recommendations_service, message_broker, "Consume: UserAction", "AMQP")
Rel(analytics_service, message_broker, "Consume: domain events", "AMQP")
Rel(image_service, message_broker, "Consume/Publish: image jobs", "AMQP")
Rel(api_gateway, message_broker, "Publish: UserAction", "AMQP")

@enduml